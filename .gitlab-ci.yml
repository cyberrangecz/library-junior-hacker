image: registry.gitlab.com/gitlab-org/terraform-images/releases/1.4:v1.0.0

stages:
  - test
  - cleanup

workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - when: always

variables:
  TF_ROOT: ${CI_PROJECT_DIR}
  TF_STATE_NAME: default

test-kypo:
  stage: test
  script:
    - echo URL=aaa.ex > deploy.env
  resource_group: ${TF_STATE_NAME}
  environment:
    name: $TF_STATE_NAME
    url: $URL
    on_stop: terraform-destroy
    auto_stop_in: 1 minute
  artifacts:
    reports:
      dotenv: deploy.env

terraform-destroy:
  stage: cleanup
  script:
    - echo destroyed
  resource_group: ${TF_STATE_NAME}
  environment:
    name: $TF_STATE_NAME
    action: stop
  when: manual
