include:
  - project: muni-kypo-images/ci-cd-virtual-images
    file: terraform.yml

stages:
  - test
  - cleanup

test-kypo:
  extends: .terraform-build
  stage: test
  environment:
    on_stop: test-kypo-cleanup

test-kypo-cleanup:
  extends:
    - test-kypo
    - .terraform-destroy
  stage: cleanup

.test-vagrant:
  image: registry.gitlab.ics.muni.cz:443/muni-kypo-images/docker-image-builder/packer:latest
  stage: test
  script:
# Add 'vb.gui = false' after every 'device.vm.provider "virtualbox" do |vb|'
    - sed -i -E 's/((\s+)device\.vm\.provider\s+"virtualbox"\s+do\s+\|([^\|]+)\|)/\1\n\2  \3.gui = false/' Vagrantfile
    - vagrant up
  tags:
    - image-builder
